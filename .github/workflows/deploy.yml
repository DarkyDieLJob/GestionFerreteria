name: Deploy (child consumer)

on:
  push:
    tags:
      - "test-*"
      # - "v*"  # opcional: habilitar releases reales
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  deploy:
    uses: ./.github/workflows/reusable-deploy.yml
    secrets: inherit
    with:
      # Nota: reusable usa directamente 'runs-on: ${{ inputs.staging_runner_label }}'
      # Por ello, aquí se pasa una sola etiqueta única del runner de staging.
      staging_runner_label: "stage"

      # Prod usa matriz: fromJSON(inputs.prod_runner_matrix_json)
      # Pasamos un arreglo JSON de etiquetas (cada item es una etiqueta única a usar en runs-on).
      prod_runner_matrix_json: '["prod"]'

      # Opcionales del reusable (descomentá si querés usarlos durante la prueba):
      profiles: "db,broker,web"
      # NOTE: There's a minimal health endpoint at /healthz/, but on staging it returns 404 for now.
      # We'll diagnose and re-enable it later. Use root path temporarily to keep pipeline green.
      smoke_url: "/"
      smoke_check_command: "python -c \"import os,urllib.request; print(urllib.request.urlopen(os.environ['SMOKE_URL']).status)\""
      smoke_timeout: 180
      migrate_before_up: true
      collectstatic: true
