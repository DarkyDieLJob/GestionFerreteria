services:
  # Base de datos Postgres (persistencia en volumen)
  db:
    image: postgres:15-alpine
    container_name: gestionferreteria-db
    restart: always
    # Desde plantilla padre (prioridad 4): perfil y healthcheck
    profiles: ["db"]
    environment:
      - POSTGRES_DB=ferreteria
      - POSTGRES_USER=usuario
      - POSTGRES_PASSWORD=changeme
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $POSTGRES_USER -d $POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Broker para Celery
  redis:
    image: redis:7-alpine
    container_name: gestionferreteria-redis
    restart: always
    # Desde plantilla padre (prioridad 4): perfil y healthcheck
    profiles: ["broker"]
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Servicio web Django (mantiene nombre/volúmenes existentes)
  app:
    build: .
    image: django-proyects:raspbian
    container_name: gestionferreteria-web
    restart: always
    # Desde plantilla padre (prioridad 4): perfilar y depender de servicios saludables
    profiles: ["web"]
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "8001:8001"
    environment:
      # Estáticos: habilitar si quieres recopilar estáticos en runtime
      - ENABLE_COLLECTSTATIC=false
      # Desde plantilla padre (prioridad 4): flags de entrypoint parametrizables
      - ENABLE_ENV_BOOTSTRAP=true
      # Opción C: runtime sin npm -> no ejecutar frontend en runtime
      - ENABLE_FRONTEND_SETUP=false
      - ENABLE_FRONTEND_BUILD=false
      - ENABLE_MIGRATE=true
      # Base de datos (habilita Postgres en settings)
      - USE_POSTGRES=true
      - POSTGRES_HOST=db
      - POSTGRES_DB=ferreteria
      - POSTGRES_USER=usuario
      - POSTGRES_PASSWORD=changeme
      - POSTGRES_PORT=5432
      # Celery/Redis
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_TIMEZONE=UTC
      # Asegura que Python encuentre el paquete core_config bajo src/
      - PYTHONPATH=/app/src
      # Modo de proyecto y modo tablet (habilita teclado virtual en contenedor)
      - PROJECT_MODE=cloud
      - TABLET_MODE=true
    volumes:
      - ./src/data:/app/src/data
      - ./src/static:/app/static
      - ./logs:/app/logs
      - ./src/media:/app/src/media
    command: ["gunicorn", "core_config.wsgi:application", "--chdir", "src", "--bind", "0.0.0.0:8001", "--workers", "2", "--timeout", "60"]

  # Worker Celery para procesamiento de planillas
  worker:
    build: .
    image: django-proyects:raspbian
    container_name: gestionferreteria-worker
    restart: always
    # Desde plantilla padre (prioridad 4): perfilar y depender de servicios saludables
    profiles: ["worker"]
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - USE_POSTGRES=true
      - POSTGRES_HOST=db
      - POSTGRES_DB=ferreteria
      - POSTGRES_USER=usuario
      - POSTGRES_PASSWORD=changeme
      - POSTGRES_PORT=5432
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_TIMEZONE=UTC
      - PYTHONPATH=/app/src
    volumes:
      - ./src/data:/app/src/data
      - ./src/static:/app/static
      - ./logs:/app/logs
      - ./src/media:/app/src/media
    command: ["celery", "-A", "core_config", "worker", "--loglevel=info", "--concurrency=1"]

volumes:
  postgres_data:
