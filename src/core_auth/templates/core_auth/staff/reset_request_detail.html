{% extends 'base.html' %}
{% block content %}
<div class="max-w-3xl mx-auto py-8">
  <a href="{% url 'core_auth:staff_reset_requests' %}" class="text-sm text-indigo-600 hover:text-indigo-800">← Volver a la lista</a>
  <h1 class="text-2xl font-semibold mb-4">Detalle de solicitud #{{ req.id }}</h1>

  <div class="bg-white shadow rounded p-4 space-y-3">
    <div><span class="font-medium">Código de solicitud:</span> <span class="font-mono">{{ req.short_code }}</span></div>
    <div><span class="font-medium">Usuario/email ingresados:</span> {{ req.username_input }} / {{ req.email_input }}</div>
    <div><span class="font-medium">Usuario asociado:</span> {% if req.user %}{{ req.user.username }} ({{ req.user.email }}){% else %}-{% endif %}</div>
    <div><span class="font-medium">Estado:</span> {{ req.get_status_display }}</div>
    <div><span class="font-medium">Creado:</span> {{ req.created_at|date:'Y-m-d H:i' }}</div>
    {% if req.expires_at %}
    <div><span class="font-medium">Vence:</span> {{ req.expires_at|date:'Y-m-d H:i' }}</div>
    {% endif %}
    <div><span class="font-medium">IP:</span> {{ req.created_ip }} | <span class="font-medium">UA:</span> <span class="break-all">{{ req.user_agent }}</span></div>

    {% if req.processed_at %}
      <div><span class="font-medium">Procesado:</span> {{ req.processed_at|date:'Y-m-d H:i' }} por {% if req.processed_by %}{{ req.processed_by.username }}{% else %}-{% endif %}</div>
    {% endif %}

    {% if req.temp_password_preview %}
    <div class="mt-2">
      <span class="font-medium">Contraseña temporal:</span>
      <input id="tmp-pass" type="text" readonly class="border rounded px-2 py-1" value="{{ req.temp_password_preview }}" />
      <button type="button" class="px-2 py-1 text-sm bg-gray-800 text-white rounded" onclick="copyTmpPass()">Copiar</button>
      <span id="copy-done" class="text-green-700 text-sm ml-2 hidden">¡Copiado!</span>
    </div>
    <script>
      function copyTmpPass(){
        const i = document.getElementById('tmp-pass');
        i.select();
        i.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(i.value).then(()=>{
          const d = document.getElementById('copy-done');
          d.classList.remove('hidden');
          setTimeout(()=>d.classList.add('hidden'), 2000);
        });
      }
    </script>
    {% endif %}

    <div class="pt-4 flex gap-2 flex-wrap">
      {% if req.status == 'pending' and req.user %}
        <a href="{% url 'core_auth:staff_reset_request_approve' req.id %}"
           class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700"
           onclick="return confirm('¿Generar contraseña temporal (no se aplicará hasta la entrega)?');">
           Generar temporal
        </a>
      {% endif %}
      {% if req.status == 'ready_to_deliver' and req.user and req.temp_password_preview %}
        <a href="{% url 'core_auth:staff_reset_request_deliver' req.id %}"
           class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
           onclick="return confirm('¿Aplicar y dar por entregada la contraseña temporal?');">
           Entregar y activar
        </a>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
